{% extends "storefront/base.html" %}
{% block content %}

<h2>Featured Products</h2>
<div class="products" id="products-container">
    {% for product in products %}
        <div class="product" data-product-id="{{ product.id }}">
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
            <h3>{{ product.name }}</h3>
            <p>{{ product.description }}</p>
            <p>Price: ${{ product.price }}</p>
            {% if product.stock > 0 %}
                <p>Available: {{ product.stock }} in stock</p>
                <div class="product-quantity">
                    <button type="button" class="quantity-button minus">-</button>
                    <span class="quantity">1</span>
                    <button type="button" class="quantity-button plus">+</button>
                </div>
                <!-- Hidden content for popup message -->
                <div class="popup-message" style="display: none;">Good</div>
                <form method="POST" action="{% url 'update_cart' %}" class="add-to-cart-form">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <input type="hidden" class="quantity-input" name="quantity" value="1">
                    <button type="submit">Add to Cart</button>
                </form>
            {% else %}
                <p>Out of stock</p>
            {% endif %}
        </div>
    {% empty %}
        <p>No products available.</p>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM fully loaded and parsed");
        updateCartCount();
        handleQuantityButtons();
        handleFormSubmission();

        function handleQuantityButtons() {
            document.querySelectorAll('.quantity-button').forEach(button => {
                button.addEventListener('click', function () {
                    const productElement = button.closest('.product');
                    const quantityElement = productElement.querySelector('.quantity');
                    const quantityInput = productElement.querySelector('.quantity-input');
                    let quantity = parseInt(quantityElement.textContent);

                    if (button.classList.contains('plus')) {
                        quantity += 1;
                    } else if (button.classList.contains('minus')) {
                        if (quantity > 1) {
                            quantity -= 1;
                        }
                    }

                    quantityElement.textContent = quantity;
                    quantityInput.value = quantity;
                });
            });
        }

        function handleFormSubmission() {
            document.querySelectorAll('.add-to-cart-form').forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const productElement = form.closest('.product');
                    const popupMessage = productElement.querySelector('.popup-message');

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    }).then(response => response.json())
                      .then(data => {
                          if (data.message) {
                              popupMessage.textContent = data.message;
                              popupMessage.style.display = 'block';
                              updateCartCount();
                              setTimeout(() => {
                                  popupMessage.style.display = 'none';
                              }, 2000);
                          } else {
                              console.error('Error:', data.error || 'Unknown error');
                          }
                      }).catch(error => {
                          console.error('Error submitting form:', error);
                      });
                });
            });
        }

        function updateCartCount() {
            fetch('{% url "get_cart_count" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received cart count:', data.cart_count);
                    document.querySelector('.cart-count').textContent = data.cart_count;
                })
                .catch(error => console.error('Error fetching cart count:', error));
        }
    });
</script>
{% endblock %}
